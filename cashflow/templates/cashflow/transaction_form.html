{% extends "cashflow/base_cashflow.html" %}
{% load i18n %}

{% block title %}{{ page_title }} - {% trans "Cash Flow" %}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        {{ page_title }}
    </div>
    <div class="card-body">
        <form method="post" id="transactionForm">
            {% csrf_token %}
            {{ form.media }} {# For widgets like Select2 if used in future #}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.transaction_date.id_for_label }}" class="form-label">{{ form.transaction_date.label }}</label>
                    {{ form.transaction_date }}
                    {% if form.transaction_date.errors %}<div class="invalid-feedback d-block">{{ form.transaction_date.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.safe.id_for_label }}" class="form-label">{{ form.safe.label }}</label>
                    {{ form.safe }}
                    {% if form.safe.errors %}<div class="invalid-feedback d-block">{{ form.safe.errors|join:", " }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                 <div class="col-md-4 mb-3">
                    <label for="{{ form.transaction_type_selector.id_for_label }}" class="form-label">{{ form.transaction_type_selector.label }}</label>
                    {{ form.transaction_type_selector }}
                    {% if form.transaction_type_selector.errors %}<div class="invalid-feedback d-block">{{ form.transaction_type_selector.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.category.id_for_label }}" class="form-label">{{ form.category.label }}</label>
                    {{ form.category }}
                    {% if form.category.errors %}<div class="invalid-feedback d-block">{{ form.category.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.sub_category.id_for_label }}" class="form-label">{{ form.sub_category.label }}</label>
                    {{ form.sub_category }}
                    {% if form.sub_category.errors %}<div class="invalid-feedback d-block">{{ form.sub_category.errors|join:", " }}</div>{% endif %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.amount.id_for_label }}" class="form-label">{{ form.amount.label }}</label>
                    {{ form.amount }}
                    {% if form.amount.errors %}<div class="invalid-feedback d-block">{{ form.amount.errors|join:", " }}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.payment_method.id_for_label }}" class="form-label">{{ form.payment_method.label }}</label>
                    {{ form.payment_method }}
                    {% if form.payment_method.errors %}<div class="invalid-feedback d-block">{{ form.payment_method.errors|join:", " }}</div>{% endif %}
                </div>
            </div>

            <!-- Bill Count Table Container -->
            <div id="billCountTableContainer" class="mb-3" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        {% trans "Bill Count Details" %}
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{% trans "Denomination" %}</th>
                                    <th>{% trans "Count" %}</th>
                                    <th>{% trans "Subtotal" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for denom in bill_denominations %}
                                <tr>
                                    <td>{{ denom }}</td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm bill-count-input" min="0" value="0" data-value="{{ denom }}">
                                    </td>
                                    <td><span class="bill-row-subtotal">0.00</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2" class="text-end">{% trans "Calculated Total from Bills:" %}</th>
                                    <td><strong id="calculatedBillsTotal">0.00</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="3">
                                        <small id="billsTotalMismatchWarning" class="text-danger float-end"></small>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.contact.id_for_label }}" class="form-label" id="contact_label">{{ form.contact.label }}</label>
                {{ form.contact }}
                {% if form.contact.errors %}<div class="invalid-feedback d-block">{{ form.contact.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                {{ form.notes }}
                {% if form.notes.errors %}<div class="invalid-feedback d-block">{{ form.notes.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">{% trans "Save Transaction" %}</button>
                <a href="{% url 'cashflow:transaction_list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelectorField = document.getElementById('{{ form.transaction_type_selector.id_for_label }}'); // Corrected ID
    const categorySelect = document.getElementById('{{ form.category.id_for_label }}');
    const subCategorySelect = document.getElementById('{{ form.sub_category.id_for_label }}');
    const contactInput = document.getElementById('{{ form.contact.id_for_label }}'); // This is the <input type="text">
    const contactDatalist = contactInput ? document.getElementById(contactInput.getAttribute('list')) : null; // Get the <datalist>
    const contactLabelElement = document.getElementById('contact_label');

    // Bill Count Elements
    const paymentMethodSelect = document.getElementById('{{ form.payment_method.id_for_label }}');
    const billCountTableContainer = document.getElementById('billCountTableContainer');
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    const billCountInputs = document.querySelectorAll('.bill-count-input');
    const calculatedBillsTotalSpan = document.getElementById('calculatedBillsTotal');
    const billsTotalMismatchWarningSpan = document.getElementById('billsTotalMismatchWarning');

    function updateOptions(selectElement, options, placeholder, currentVal) {
        selectElement.innerHTML = ''; 
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = placeholder || '---------';
        selectElement.appendChild(defaultOption);
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.id;
            option.textContent = opt.name;
            if (currentVal && opt.id == currentVal) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    function updateDatalistOptions(datalistElement, contactsData) {
        if (!datalistElement) return;
        datalistElement.innerHTML = ''; // Clear existing options
        contactsData.forEach(contact => {
            const option = document.createElement('option');
            option.value = contact.name;
            // Optionally, you can add contact.name as text content too, some browsers might show it
            // option.textContent = contact.name;
            datalistElement.appendChild(option);
        });
    }

    function loadCategoriesAndContacts() {
        const transactionTypeCode = transactionTypeSelectorField.value;
        categorySelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
        subCategorySelect.innerHTML = '<option value="">---------</option>';
        // For datalist, we don't clear the input field's value here, just update its list
        // contactInput.value = ''; // Do not clear the typed value

        if (transactionTypeCode) {
            // Load Categories
            fetch(`{% url 'cashflow:ajax_load_categories' %}?transaction_type_code=${transactionTypeCode}`)
                .then(response => response.json())
                .then(data => {
                    updateOptions(categorySelect, data, "{% trans 'Select Category' %}", "{% if form.instance.pk %}{{ form.instance.category.id }}{% endif %}");
                    // If editing, and category was pre-selected, trigger subcategory load
                    if (categorySelect.value) { 
                        categorySelect.dispatchEvent(new Event('change'));
                    }
                });

            // Load Contacts and update label for Datalist
            fetch(`{% url 'cashflow:ajax_load_contacts' %}?transaction_type_code=${transactionTypeCode}`)
                .then(response => response.json())
                .then(data => {
                    updateDatalistOptions(contactDatalist, data.contacts);
                    if (contactLabelElement) contactLabelElement.textContent = data.label;
                });
        } else {
            updateOptions(categorySelect, [], "{% trans 'Select Category' %}");
            updateOptions(subCategorySelect, [], "{% trans 'Select SubCategory' %}");
            updateDatalistOptions(contactDatalist, []); // Clear datalist options
            if (contactLabelElement) contactLabelElement.textContent = "{% trans 'Contact' %}";
        }
    }

    transactionTypeSelectorField.addEventListener('change', loadCategoriesAndContacts);

    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        subCategorySelect.innerHTML = '<option value="">{% trans "Loading..." %}</option>';
        
        if (categoryId) {
            fetch(`{% url 'cashflow:ajax_load_subcategories' %}?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    updateOptions(subCategorySelect, data, "{% trans 'Select SubCategory' %}", "{% if form.instance.pk and form.instance.sub_category %}{{ form.instance.sub_category.id }}{% endif %}");
                });
        } else {
            updateOptions(subCategorySelect, [], "{% trans 'Select SubCategory' %}");
        }
    });

    // Initial load if editing or if there's an initial value for transaction_type_selector
    if (transactionTypeSelectorField.value) {
        loadCategoriesAndContacts();
    }
    // If editing and category is already set, ensure subcategories and contacts are also set correctly
    {% if form.instance.pk and form.instance.category.id %}
        if (categorySelect.value === "{{ form.instance.category.id }}") {
            categorySelect.dispatchEvent(new Event('change'));
        }
    {% endif %}

    // --- Bill Count Logic ---
    function toggleBillCountTable() {
        if (paymentMethodSelect.value === 'cash') {
            billCountTableContainer.style.display = '';
        } else {
            billCountTableContainer.style.display = 'none';
            // Clear bill inputs and totals when hiding, and remove validation errors
            billCountInputs.forEach(input => {
                input.value = '0';
            });
            updateBillCalculations(); // Recalculate to zero out and clear warnings
            amountInput.setCustomValidity(''); // Clear potential previous validation message
            billsTotalMismatchWarningSpan.textContent = '';
        }
        validateBillTotal(); // Re-validate based on visibility
    }

    function updateBillCalculations() {
        let overallTotalFromBills = 0;
        billCountInputs.forEach(input => {
            const count = parseInt(input.value) || 0;
            const billValue = parseFloat(input.dataset.value);
            const subtotal = count * billValue;
            // Find the closest 'tr' and then the subtotal span within that row
            const row = input.closest('tr');
            if (row) {
                const subtotalSpan = row.querySelector('.bill-row-subtotal');
                if (subtotalSpan) {
                    subtotalSpan.textContent = subtotal.toFixed(2);
                }
            }
            overallTotalFromBills += subtotal;
        });
        calculatedBillsTotalSpan.textContent = overallTotalFromBills.toFixed(2);
        validateBillTotal();
    }

    function validateBillTotal() {
        const mainAmount = parseFloat(amountInput.value) || 0;
        const billsTotal = parseFloat(calculatedBillsTotalSpan.textContent) || 0;

        if (paymentMethodSelect.value === 'cash' && mainAmount !== billsTotal) {
            billsTotalMismatchWarningSpan.textContent = "{% trans 'Bills total does not match Amount field.' %}";
            calculatedBillsTotalSpan.classList.add('text-danger');
            // Set custom validity on the amount field to prevent submission if desired
            // amountInput.setCustomValidity("{% trans 'Calculated bills total must match this amount when payment method is Cash.' %}");
        } else {
            billsTotalMismatchWarningSpan.textContent = "";
            calculatedBillsTotalSpan.classList.remove('text-danger');
            amountInput.setCustomValidity("");
        }
    }

    if (paymentMethodSelect) {
        paymentMethodSelect.addEventListener('change', toggleBillCountTable);
        // Initial check on page load
        toggleBillCountTable();
    }

    billCountInputs.forEach(input => {
        input.addEventListener('input', updateBillCalculations);
    });

    if (amountInput) {
        amountInput.addEventListener('input', validateBillTotal);
    }

    // Clear bill counts if amount is manually changed and payment method is cash
    // This is an optional behavior, can be refined.
    // if (amountInput && paymentMethodSelect) {
    //     amountInput.addEventListener('change', function() {
    //         if (paymentMethodSelect.value === 'cash') {
    //             // Potentially clear bills or show a more prominent warning
    //             // For now, just re-validating is handled by the input event.
    //         }
    //     });
    // }

    // Ensure form validation considers custom validity
    const transactionForm = document.getElementById('transactionForm');
    if (transactionForm) {
        transactionForm.addEventListener('submit', function(event) {
            // Re-validate before submit, especially for the amount field's custom validity
            validateBillTotal();
            if (!transactionForm.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                // Optionally, you can focus on the first invalid field or show a general error
                // For example, if amountInput is invalid:
                if (!amountInput.checkValidity()){
                    amountInput.focus();
                    billsTotalMismatchWarningSpan.textContent = amountInput.validationMessage;
                }
            }
            // This will add Bootstrap's was-validated class to show feedback
            transactionForm.classList.add('was-validated');
        });
    }

});
</script>
{% endblock %}

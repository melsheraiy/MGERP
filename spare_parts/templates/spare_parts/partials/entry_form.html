{% load i18n %}
{% comment %}
Pass 'form' (SparePartRequestForm) or 'supervisor_form' (SupervisorSparePartEditForm)
and 'is_supervisor' boolean to this template.
The actual form instance used depends on whether it's a new entry or an edit by a supervisor.
JavaScript will handle showing the correct fields for supervisor edit.
{% endcomment %}

<form id="sparePartForm" class="container mt-2 p-3 border rounded bg-white shadow-sm" dir="rtl" novalidate>
  {% csrf_token %}
  <h4 class="text-center mb-3" id="entryFormTitle">{% translate "New Spare Part Request Form" %}</h4>

  <input type="hidden" id="entryId" name="id">
  <input type="hidden" id="currentStatusHidden"> {% comment %} Stores current status for non-supervisor edits {% endcomment %}
  <input type="hidden" id="currentPhotoDriveId"> {% comment %} In Django, this will be photo URL or empty {% endcomment %}

  {% with active_form=supervisor_form|default:form %}
  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="{{ active_form.category.id_for_label }}">{{ active_form.category.label }}</label>
      {{ active_form.category }}
      <div class="invalid-feedback">{{ active_form.category.errors|first }}</div>
    </div>
    <div class="form-group col-md-6">
      <label for="{{ active_form.unit.id_for_label }}">{{ active_form.unit.label }}</label>
      {{ active_form.unit }}
      <div class="invalid-feedback">{{ active_form.unit.errors|first }}</div>
    </div>
  </div>

  <div class="form-group">
    <label for="{{ active_form.description.id_for_label }}">{{ active_form.description.label }}</label>
    {{ active_form.description }}
    <div class="invalid-feedback">{{ active_form.description.errors|first }}</div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="{{ active_form.requested_qty.id_for_label }}">{{ active_form.requested_qty.label }}</label>
      {{ active_form.requested_qty }}
      <div class="invalid-feedback">{{ active_form.requested_qty.errors|first }}</div>
    </div>
    <div class="form-group col-md-6">
      <label for="{{ active_form.photo.id_for_label }}">{{ active_form.photo.label }}</label>
      {{ active_form.photo }}
      <small class="form-text text-muted">{{ active_form.photo.help_text }}</small>
      <div class="invalid-feedback">{{ active_form.photo.errors|first }}</div>
    </div>
  </div>

  <div class="form-row mb-2">
    <div class="col-md-6" id="currentPhotoPreviewContainer" style="display:none;">
        <label class="float-right">{% translate "Current Photo" %}:</label><br>
        <a href="#" id="currentPhotoLink" target="_blank">
            <img id="currentPhotoPreview" src="#" alt="{% translate 'Current Photo' %}">
        </a>
        {% if active_form.remove_photo %}
        <div class="form-check mt-1">
            {{ active_form.remove_photo }}
            <label class="form-check-label" for="{{ active_form.remove_photo.id_for_label }}">
                {{ active_form.remove_photo.label }}
            </label>
        </div>
        {% endif %}
    </div>
    <div class="col-md-6" id="newPhotoPreviewContainer" style="display:none;">
        <label class="float-right">{% translate "New Photo Preview" %}:</label><br>
        <img id="newPhotoPreview" src="#" alt="{% translate 'New Photo Preview' %}">
    </div>
  </div>

  <div class="form-group">
    <label for="{{ active_form.notes.id_for_label }}">{{ active_form.notes.label }}</label>
    {{ active_form.notes }}
    <div class="invalid-feedback">{{ active_form.notes.errors|first }}</div>
  </div>

  {% if is_supervisor and supervisor_form %}
  <div id="supervisorStatusSection" class="form-group" style="display:none;"> {# JS will show this section if editing as supervisor #}
    <label for="{{ supervisor_form.status.id_for_label }}">{{ supervisor_form.status.label }}</label>
    {{ supervisor_form.status }}
    <div class="invalid-feedback">{{ supervisor_form.status.errors|first }}</div>

    <div class="form-group mt-2" id="receivedQtyGroup" style="display:none;"> {# JS shows if status is 'Received' #}
      <label for="{{ supervisor_form.received_qty_form_input.id_for_label }}">{{ supervisor_form.received_qty_form_input.label }}</label>
      {{ supervisor_form.received_qty_form_input }}
      <div class="invalid-feedback">{{ supervisor_form.received_qty_form_input.errors|first }}</div>
    </div>
  </div>
  {% endif %}
  {% endwith %}

  <div class="form-group text-center mt-3">
    <button type="button" class="btn btn-primary mr-2" id="submitSparePartFormBtn">
        <span class="submit-text">{% translate "Save Request" %}</span>
        <span class="spinner-border spinner-border-sm loading-spinner" role="status" aria-hidden="true" style="display: none;"></span>
    </button>
    <button type="button" class="btn btn-secondary" id="clearEntryFormBtn">{% translate "Clear & New Entry" %}</button>
  </div>
  <div id="formMessage" class="mt-2 text-center small"></div>
</form>
